<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--Link para utilizar o Bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <link rel="stylesheet" href="paciente.css">

    <title>Cadastro Paciente</title>
</head>



<body>
    <nav>
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <!--<a class="navbar-brand" href="#">Meta Saúde</a>-->
                <a class="navbar-brand" style="color: white;" href="principal.html">
                    <img src="img/icons8-coração-com-pulso-48.png" alt="Bootstrap" width="55" height="45">Meta Saúde
                </a>

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
        </nav>

        <ul class="breadcrumb">
            <li><a href="principal.html">Home ></a></li>
            <li>Cadastros</li>
        </ul>

        <!-- <header>
        <div class="topnav" id="myTopnav">
            <a href="#contato">Contato</a>
            <a href="#medicos">Médicos</a>
            <a href="#horarios">Horários</a>
            <a href="#usuarios" class="active">Usuários</a>
            <div class="brand"><a href="principal.html">Meta Saúde</a></div>
        </div>
    </header>-->

        <h1>Cadastrar Paciente</h1>

        <form id="contactForm">
            <div>
                <label for="nome">Nome:</label>
                <input id="name" placeholder="Nome" type="text" required>

                <label for="sexo">Sexo:</label>
                <select id="sexo" required>
                    <option value="">Selecione</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Feminino">Feminino</option>
                </select>

            </div>

            <div>
                <label for="cpf">CPF:</label>
                <input placeholder="Digite o CPF do Paciente" id="cpf" type="text" required>
                <label for="data">Data Nasc:</label>
                <input id="aniv" placeholder="Digite sua Idade" pattern="\d{2}\/\d{2}\/\d{4}" type="date" required>

            </div>

            <div>
                <label for="numero carteira">No. Carteira:</label>
                <input id="carteira" placeholder="Digite o Número da Carteira" type="text" required>
            </div>

            <div>
                <label for="nome da mae">Mãe:</label>
                <input id="mae" placeholder="Digite o Nome da Mãe" type="text" required>
            </div>

            <div>
                <label for="endereco">Endereço:</label>
                <input id="end" placeholder="Digite o Endereço" type="text" required>
            </div>

            <div>
                <label for="city">Cidade:</label>
                <input id="cep" placeholder="Digite sua Cidade" type="text" required>

                <select name="uf" id="uf">
                    <option value=""> UF </option>
                    <option value="AC"> AC </option>
                    <option value="AL"> AL </option>
                    <option value="AM"> AM </opção>
                    <option value="AP"> AP </opção>
                    <option value="BA"> BA </option>
                    <option value="CE"> CE </option>
                    <option value="DF"> DF </option>
                    <option value="ES"> ES </option>
                    <option value="GO"> GO </option>
                    <option value="MA"> MA </option>
                    <option value="MG"> MG </option>
                    <option value="MS"> MS </option>
                    <option value="MT"> MT </option>
                    <option value="PA"> PA </option>
                    <option value="PB"> PB </option>
                    <option value="PE"> PE </option>
                    <option value="PI"> PI </opção>
                    <option value="PR"> PR </opção>
                    <option value="RJ"> RJ </option>
                    <option value="RN"> RN </option>
                    <option value="RS"> RS </option>
                    <option value="RO"> RO </opção>
                    <option value="RR"> RR </opção>
                    <option value="SC"> SC </option>
                    <option value="SE"> SE </option>
                    <option value="SP"> SP </option>
                    <option value="TO"> TO </option>
                </select>
            </div>

            <div>
                <label for="diag">Diagnóstico:</label>
                <input id="diag" placeholder="Digite aqui" type="text" required>
            </div>

            <div id="compl">
                <label for="comp">Complemento:</label>
                <textarea id="text"></textarea>
            </div>

            <div class="button">
                <button id="botao" type="submit" value="Gravar">Gravar</button>
            </div>

        </form>




        <!--Rodapé da página-->
        <footer>
            <p>Desenvolvido por Matriz Sistemas &copy; 2023<br>
                <span class="separator">|</span>
                <a href="#">Política de Privacidade</a>
            </p>
        </footer>

        <!-- Inclua a biblioteca do Firebase-->
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
        <script src="https://unpkg.com/imask"></script>
        <!--<script src="user.js"></script>-->



        <script>
            // const firebaseConfig = {
            //     apiKey: "AIzaSyB7Uaucaj_P_7fUjCwm66daf_UVpOMFpRc",
            //     authDomain: "met-saud.firebaseapp.com",
            //     databaseURL: "https://met-saud-default-rtdb.firebaseio.com",
            //     projectId: "met-saud",
            //     storageBucket: "met-saud.appspot.com",
            //     messagingSenderId: "412539453888",
            //     appId: "1:412539453888:web:598f256cf829e2fd814825"
            // };
            const firebaseConfig = {
                apiKey: "AIzaSyDKob-B0j3wr00DW9123F611OCA9Te8YoM",
                authDomain: "metasaudebd.firebaseapp.com",
                databaseURL: "https://metasaudebd-default-rtdb.firebaseio.com/",
                projectId: "metasaudebd",
                storageBucket: "metasaudebd.appspot.com",
                messagingSenderId: "254549055773",
                appId: "1:254549055773:web:85d985f84d3b7c9174a9f4",
                measurementId: "G-0PM66J8B4Z"
            };

            firebase.initializeApp(firebaseConfig);

            //Criando instância para o Realtime Database
            const database = firebase.database();

            //Criando instância para o Cloud Firestore
            const db = firebase.firestore();
            const providerData = null;

            // Manipulando o evento de envio do formulário
            const form = document.querySelector('#contactForm');
            form.addEventListener('submit', async (event) => {
                event.preventDefault(); // Evita o comportamento padrão de envio do formulário

                // Obtendo os dados do formulário
                const name = form.name.value;
                const sexo = form.sexo.value;
                const cpf = form.cpf.value;
                //const aniv = form.aniv.value;
                const aniv = formatDate(form.aniv.value);
                function formatDate(dateString) {
                    const dateParts = dateString.split('-');
                    const day = dateParts[2];
                    const month = dateParts[1];
                    const year = dateParts[0];
                    return `${day}/${month}/${year}`;
                }
                const carteira = form.carteira.value;
                const mae = form.mae.value;
                const end = form.end.value;
                const cep = form.cep.value;
                const uf = form.uf.value;
                const diag = form.diag.value;
                const text = form.text.value;


                // Obtendo o usuário logado atualmente
                const currentUser = localStorage.getItem('currentUser');

                try {
                    // Consultando a coleção "usuarios" para verificar se o usuário existe
                    const usuariosSnapshot = await db.collection('usuarios').where('login', '==', currentUser).get();
                    if (!usuariosSnapshot.empty) {
                        // O usuário existe na coleção "usuarios"
                        const user = usuariosSnapshot.docs[0].data();
                        const operadora = user.operadora;

                        // Salvando os dados do paciente na coleção "pacientes"
                        const pacienteData = {
                            name: name,
                            sexo: sexo, // Inclua o valor do campo de sexo nos dados do paciente
                            cpf: cpf,
                            aniv: aniv,
                            carteira: carteira,
                            mae: mae,
                            operadora: operadora,
                            end: end,
                            cep: cep,
                            uf: uf,
                            diag: diag,
                            text: text,

                        };

                        // Obtendo a referência para a coleção "pacientes"
                        const pacientesRef = db.collection('pacientes');

                        // Adicionando o paciente à coleção "pacientes"
                        const newPacienteRef = await pacientesRef.add(pacienteData);
                        const newPacienteId = newPacienteRef.id;

                        // Atualizando o campo "oper" com o valor "0" no documento do paciente
                        // await newPacienteRef.update({ oper: 1 });
                        // Atualizando o campo "oper" com o valor "0" no documento do paciente
                        /* const operValue = Date.now();
                         await newPacienteRef.update({ oper: operValue });*/

                        console.log('Dados do paciente salvos com sucesso na coleção "pacientes".');
                        form.reset(); // Limpando o formulário após o envio

                        // Exibindo mensagem de sucesso
                        const successMessage = document.createElement('p');
                        successMessage.textContent = 'Cadastro Realizado com Sucesso! Retornando a página principal.';
                        form.appendChild(successMessage);
                        // Redirecionando para a página principal após 5 segundos
                        setTimeout(() => {
                            window.location.href = 'principal.html';
                        }, 3000); // 5000 milissegundos = 3 segundos
                    } else {
                        // Se o usuário não existe na coleção "usuarios", verificar na coleção "hospitais"
                        const hospitaisSnapshot = await db.collection('hospitais').where('login', '==', currentUser).get();
                        if (!hospitaisSnapshot.empty) {
                            // O usuário existe na coleção "hospitais"
                            const hospital = hospitaisSnapshot.docs[0].data();
                            const operadora = hospital.operadora;

                            // Salvando os dados do paciente na coleção "pacientes"
                            const pacienteData = {
                                name: name,
                                sexo: sexo, // Inclua o valor do campo de sexo nos dados do paciente
                                cpf: cpf,
                                aniv: aniv,
                                mae: mae,
                                operadora: operadora,
                                end: end,
                                cep: cep,
                                uf: uf,
                                diag: diag,
                                text: text
                            };

                            // Obtendo a referência para a coleção "pacientes"
                            const pacientesRef = db.collection('pacientes');

                            // Adicionando o paciente à coleção "pacientes"
                            await pacientesRef.add(pacienteData);

                            console.log('Dados do paciente salvos com sucesso na coleção "pacientes".');
                            form.reset(); // Limpando o formulário após o envio
                            // Exibindo mensagem de sucesso
                            const successMessage = document.createElement('p');
                            successMessage.textContent = 'Cadastro Realizado com Sucesso! Retornando a página principal em 5 segundos.';
                            form.appendChild(successMessage)
                            // Redirecionando para a página principal após 5 segundos
                            setTimeout(() => {
                                window.location.href = 'principal.html';
                            }, 3000); // 5000 milissegundos = 5 segundos
                        } else {
                            console.error("Usuário não encontrado nas coleções 'usuarios' e 'hospitais'.");
                        }
                    }
                } catch (error) {
                    console.error('Erro ao buscar usuário:', error);
                }
            });

            document.addEventListener('DOMContentLoaded', function () {
                var cpfInput = document.getElementById('cpf');
                var cpfMask = IMask(cpfInput, {
                    mask: '000.000.000-00'
                });
            });
        </script>

</body>


</html>